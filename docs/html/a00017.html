<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ucc: Compiler</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>Compiler</h1>
<p>
<div class="dynheader">
Collaboration diagram for Compiler:</div>
<div class="dynsection">
<center><table><tr><td><img src="a00017.png" border="0" alt="" usemap="#a00038_map">
<map name="a00038_map">
<area shape="rect" href="a00023.html" title="Compiler implementation" alt="" coords="135,5,319,32"><area shape="rect" href="a00018.html" title="Parse tree layers" alt="" coords="161,56,292,83"></map></td></tr></table></center>
</div>
<hr><a name="_details"></a><h2>Detailed Description</h2>
The <b>compiler</b> translates the <em>C-like input language</em> into the <em>assembly-like output language</em>. 
<p>
In particular, each function in the input language is translated into a <b>symbol table entry</b> that references an <b>assembly code block</b>, implemented in <a class="el" href="a00012.html" title="Assembly instruction.">vm_instr</a> structure. Therefore, compiler main goal is to create such code block, given the assembly instructions that each <b>simple instruction</b> generate. There are two types of simple instructions in the input language:<p>
<ul>
<li>
Comparison instructions; </li>
<li>
The exec() function. </li>
</ul>
<p>
The former type generates three assembly instructions: one to actually evaluate the result comparing two registers, and two conditional jumps for the true and false case. We assume that the virtual machine sets an internal flag after the comparison instruction, to be checked by the following conditional jumps. The latter type generates just one assembly instruction.<p>
At this point, it should be obvious that we may have two different basic code blocks. Infact, the block generated by comparison evaluation instructions may jump to two different locations, depending on the result; while the one generated by exec() instruction always jump to a location which is the next code block. We define <b>comparison code block</b> the former, and <b>complete code block</b> the latter.<p>
For handling this differencies, we wrap code blocks with another structure: the <b>parse tree node</b>, implemented in <a class="el" href="a00006.html" title="Parsing tree node.">p_node</a>. Such polimorphic struct may reference two different data types:<p>
<ul>
<li>
A block of code during its lifecycle; </li>
<li>
A lexeme passed from scanner. </li>
</ul>
<p>
As its name suggests, <a class="el" href="a00006.html" title="Parsing tree node.">p_node</a> represent a node in the parsing tree, which is a tree defined by parser rules. Note that we don't explicitly build the tree, which will be a memory consuming task; instead, each parser rule consumes one or more input nodes to create an output node. When a node is no longer needed, it is destroyed. Furthermore, we keep a cache of unused nodes, to avoid invoking the operating system for dynamical memory too often. There is a specific section that outligths memory management.<p>
There are four different types of <a class="el" href="a00006.html" title="Parsing tree node.">p_node</a>:<p>
<pre>
   unused     : managed by the unused node cache
   lexeme     : references a lexeme
   complete   : references a complete code block
   comparison : references a comparison code block
 </pre><p>
The parse tree is layered in four levels:<p>
<ol>
<li>
<em>Simple instruction translation;</em> </li>
<li>
<em>Boolean expression evaluation;</em> </li>
<li>
<em>Control flow instruction evaluation;</em> </li>
<li>
<em>Next-block chaining.</em> </li>
</ol>
<p>
In the first layer the compiler creates parsing tree nodes, either complete or comparison, depending on the input file. At this point, it is not known which is the next location for complete nodes, and which are the true and false location to jump to for comparison ones. This problem is solved keeping a list of instructions that reference unknown locations within a node. When a locations becomes known, such list is walked, patching the instructions with the proper offset. For implementing this tecnique, known as <b>backpatching</b>, we use <a class="el" href="a00001.html" title="Entry in backpatch list.">bp_entry</a> structure.<p>
In the second layer boolean expressions are evaluated. This is implemented concatenating code blocks, and merging or backpatching true and false lists. For instance, in case of <em>boolean and</em>, the result node merges the true lists of original nodes, and backpatches the false list of the first one to jump at the beginning of the second's code block.<p>
In the third layer control flow instructions are evaluated. The side effect is that all true and false locations becomes known, so the final node will have just a nextlist to backpatch. Infact, at this point, the node does not known which the next code block will be. Note that, at the end of this layer, we will have around complete nodes only.<p>
In the fourth layer we chain complete nodes, until the parser reduces a complete function. When we have a complete function, we add <code>VM_RETURN</code> instruction to the code block, and we patch nextlist with the location of such instruction. The result is a code block without unknown locations, which is installed in the symbol table, using the function name as lookup key. 
<p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Modules</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00018.html">Parse tree layers</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00023.html">Compiler implementation</a></td></tr>

<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00012.html">vm_instr</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Assembly instruction.  <a href="a00012.html#_details">More...</a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00001.html">bp_entry</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Entry in backpatch list.  <a href="a00001.html#_details">More...</a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00006.html">p_node</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Parsing tree node.  <a href="a00006.html#_details">More...</a><br></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00017.html#g2ceb5b985e149f18e018b142cfdd7264">YYSTYPE</a>&nbsp;&nbsp;&nbsp;<a class="el" href="a00006.html">p_node</a> *</td></tr>

<tr><td colspan="2"><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00017.html#g771982a94a1d0eed1c91e2466c6dfaea">vm_opcode</a> { <br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaeabc623197ee0be09dba239afb5e206255">VM_NOP</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaea948e7f215ed773e88d6561e805f4217c">VM_EXEC</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaea3d1e0b4b3e5f34eb408f8249a2922ebf">VM_EQ</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaea7c685322e08a89b4db762d31259c1920">VM_MAG</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaea431018f9ab88a59ce34b9cf321713de5">VM_MIN</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaeab3f5f0237b369c71325eaaa2871d1331">VM_MAEQ</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaea36d2a3364e24fd112042f9f844645c6d">VM_MIEQ</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaead7242cf2580a4b4325ab7148c73c18ad">VM_NEQ</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaeac11daeb2a8f1eb6e5e266f0a74f14314">VM_JTRUE</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaeaa4342367d401b0d7cc52968976499553">VM_JFALSE</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaea78d450f269269666ce0a58fba76c4e49">VM_JMP</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="a00017.html#gg771982a94a1d0eed1c91e2466c6dfaea01a05faf14b070cd6106b25e484341c1">VM_RETURN</a>
<br>
 }</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00017.html#g0525311b7d5bfacc661d0ed88468ba8b">subsys_code_init</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00017.html#ga7444b69cf2b66aed8c0a99b7ff97199">code_generate</a> (void)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="g2ceb5b985e149f18e018b142cfdd7264"></a><!-- doxytag: member="compiler.h::YYSTYPE" ref="g2ceb5b985e149f18e018b142cfdd7264" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define YYSTYPE&nbsp;&nbsp;&nbsp;<a class="el" href="a00006.html">p_node</a> *          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This is the type that will be used in parser and scanner. 
<p>

</div>
</div><p>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="g771982a94a1d0eed1c91e2466c6dfaea"></a><!-- doxytag: member="compiler.h::vm_opcode" ref="g771982a94a1d0eed1c91e2466c6dfaea" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="a00017.html#g771982a94a1d0eed1c91e2466c6dfaea">vm_opcode</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Available assembly instructions. 
<p>
<dl compact><dt><b>Enumerator: </b></dt><dd>
<table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaeabc623197ee0be09dba239afb5e206255"></a><!-- doxytag: member="VM_NOP" ref="gg771982a94a1d0eed1c91e2466c6dfaeabc623197ee0be09dba239afb5e206255" args="" -->VM_NOP</em>&nbsp;</td><td>
Do nothing instruction. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaea948e7f215ed773e88d6561e805f4217c"></a><!-- doxytag: member="VM_EXEC" ref="gg771982a94a1d0eed1c91e2466c6dfaea948e7f215ed773e88d6561e805f4217c" args="" -->VM_EXEC</em>&nbsp;</td><td>
Execute an external program. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaea3d1e0b4b3e5f34eb408f8249a2922ebf"></a><!-- doxytag: member="VM_EQ" ref="gg771982a94a1d0eed1c91e2466c6dfaea3d1e0b4b3e5f34eb408f8249a2922ebf" args="" -->VM_EQ</em>&nbsp;</td><td>
Set trueflag if two strings equal. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaea7c685322e08a89b4db762d31259c1920"></a><!-- doxytag: member="VM_MAG" ref="gg771982a94a1d0eed1c91e2466c6dfaea7c685322e08a89b4db762d31259c1920" args="" -->VM_MAG</em>&nbsp;</td><td>
Set trueflag if the first string is major than the second. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaea431018f9ab88a59ce34b9cf321713de5"></a><!-- doxytag: member="VM_MIN" ref="gg771982a94a1d0eed1c91e2466c6dfaea431018f9ab88a59ce34b9cf321713de5" args="" -->VM_MIN</em>&nbsp;</td><td>
Set trueflag if the first string is minor than the second. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaeab3f5f0237b369c71325eaaa2871d1331"></a><!-- doxytag: member="VM_MAEQ" ref="gg771982a94a1d0eed1c91e2466c6dfaeab3f5f0237b369c71325eaaa2871d1331" args="" -->VM_MAEQ</em>&nbsp;</td><td>
Set trueflag if the first string is not minor than the second. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaea36d2a3364e24fd112042f9f844645c6d"></a><!-- doxytag: member="VM_MIEQ" ref="gg771982a94a1d0eed1c91e2466c6dfaea36d2a3364e24fd112042f9f844645c6d" args="" -->VM_MIEQ</em>&nbsp;</td><td>
Set trueflag if the first string is not major than the second. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaead7242cf2580a4b4325ab7148c73c18ad"></a><!-- doxytag: member="VM_NEQ" ref="gg771982a94a1d0eed1c91e2466c6dfaead7242cf2580a4b4325ab7148c73c18ad" args="" -->VM_NEQ</em>&nbsp;</td><td>
Set trueflag if two strings differ. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaeac11daeb2a8f1eb6e5e266f0a74f14314"></a><!-- doxytag: member="VM_JTRUE" ref="gg771982a94a1d0eed1c91e2466c6dfaeac11daeb2a8f1eb6e5e266f0a74f14314" args="" -->VM_JTRUE</em>&nbsp;</td><td>
Jump to location if trueflag is set. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaeaa4342367d401b0d7cc52968976499553"></a><!-- doxytag: member="VM_JFALSE" ref="gg771982a94a1d0eed1c91e2466c6dfaeaa4342367d401b0d7cc52968976499553" args="" -->VM_JFALSE</em>&nbsp;</td><td>
Jump to location if trueflag isn't set. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaea78d450f269269666ce0a58fba76c4e49"></a><!-- doxytag: member="VM_JMP" ref="gg771982a94a1d0eed1c91e2466c6dfaea78d450f269269666ce0a58fba76c4e49" args="" -->VM_JMP</em>&nbsp;</td><td>
Jump to location. 
<p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="gg771982a94a1d0eed1c91e2466c6dfaea01a05faf14b070cd6106b25e484341c1"></a><!-- doxytag: member="VM_RETURN" ref="gg771982a94a1d0eed1c91e2466c6dfaea01a05faf14b070cd6106b25e484341c1" args="" -->VM_RETURN</em>&nbsp;</td><td>
Return from function. 
<p>
</td></tr>
</table>
</dl>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="g0525311b7d5bfacc661d0ed88468ba8b"></a><!-- doxytag: member="compiler.h::subsys_code_init" ref="g0525311b7d5bfacc661d0ed88468ba8b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void subsys_code_init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initialize code generation subsystem. 
</div>
</div><p>
<a class="anchor" name="ga7444b69cf2b66aed8c0a99b7ff97199"></a><!-- doxytag: member="compiler.h::code_generate" ref="ga7444b69cf2b66aed8c0a99b7ff97199" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void code_generate           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Output all the code generated so far. 
<p>

</div>
</div><p>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Feb 11 17:23:33 2008 for ucc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
